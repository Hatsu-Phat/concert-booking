ALTER SESSION SET CURRENT_SCHEMA = CONCERT_BOOKING;

CREATE TABLE DIADIEM(
    MaDiaDiemNum    NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    MaDiaDiem       CHAR(10) UNIQUE,
    TenDiaDiem      NVARCHAR2(255) NOT NULL,
    SucChua         NUMBER(38) NOT NULL,
    DiaChi          NVARCHAR2(255) NOT NULL
);

CREATE TABLE SUKIEN(
    MaSuKienNum         NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    MaSuKien            CHAR(10) UNIQUE,
    TenSuKien           NVARCHAR2(255) NOT NULL,
    ThoiGian            DATE NOT NULL,
    MoTa                NVARCHAR2(1000),
    TrangThai           NVARCHAR2(25) DEFAULT 'Chưa diễn ra',
    TyLeHoaHong         NUMBER(5,2),
    QuyDinhSuKien       NVARCHAR2(1000),
    MaDiaDiemNum        NUMBER,
    MaChinhSachHTNum    NUMBER,
    CONSTRAINT CK_TrangThai CHECK (TrangThai IN ('Sắp diễn ra', 'Đang diễn ra', 'Chưa diễn ra')),
    CONSTRAINT FK_SK_DD FOREIGN KEY (MaDiaDiemNum) REFERENCES DIADIEM(MaDiaDiemNum),
    CONSTRAINT FK_SK_MCSHT FOREIGN KEY (MaChinhSachHTNum) REFERENCES MAUCHINHSACHHOANTIEN(MaChinhSachHTNum)
);

CREATE TABLE SUATDIEN(
    MaSuatDienNum   NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    MaSuatDien      CHAR(10) UNIQUE,
    TenSuatDien     NVARCHAR2(255) NOT NULL,
    ThoiGianBatDau  DATE NOT NULL,
    ThoiGianKetThuc DATE,
    TrangThaiBanVe  NVARCHAR2(50),
    MaSuKienNum     NUMBER,
    CONSTRAINT FK_SD_SK FOREIGN KEY (MaSuKienNum) REFERENCES SUKIEN(MaSuKienNum)
);

CREATE TABLE NHATAITRO (
    MaNhaTTNum   NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    MaNhaTT      CHAR(10) UNIQUE,
    TenNhaTT     NVARCHAR2(255) NOT NULL
);

CREATE TABLE TAITRO (
    MaSuKienNum  NUMBER,
    MaNhaTTNum   NUMBER,
    HangTaiTro   NVARCHAR2(20) DEFAULT 'Chưa có hạng tài trợ',
    CONSTRAINT PK_TAITRO PRIMARY KEY (MaSuKienNum, MaNhaTTNum),
    CONSTRAINT FK_TAITRO_SK FOREIGN KEY (MaSuKienNum) REFERENCES SUKIEN(MaSuKienNum),
    CONSTRAINT FK_TAITRO_NTT FOREIGN KEY (MaNhaTTNum) REFERENCES NHATAITRO(MaNhaTTNum),
    CONSTRAINT CHK_HangTaiTro CHECK (HangTaiTro IN ('Đồng', 'Bạc', 'Vàng', 'Kim Cương'))
);

CREATE TABLE KHUVUC(
    MaKhuVucNum  NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    MaKhuVuc     CHAR(10) UNIQUE,
    TenKhuVuc    NVARCHAR2(100) NOT NULL,
    SucChuaKV    NUMBER(10) NOT NULL,
    MaSuKienNum  NUMBER,
    CONSTRAINT FK_KV_SK FOREIGN KEY (MaSuKienNum) REFERENCES SUKIEN(MaSuKienNum)
);

CREATE TABLE GHENGOI(
    MaGheNum     NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    MaGhe        CHAR(10) UNIQUE,
    SoHang       NUMBER(5),
    SoGhe        NUMBER(5),
    ToaDo        VARCHAR2(50),
    MaKhuVucNum  NUMBER,
    CONSTRAINT FK_GHE_KV FOREIGN KEY (MaKhuVucNum) REFERENCES KHUVUC(MaKhuVucNum)
);

CREATE TABLE TRANGTHAIGHETHEOSUAT(
    MaGheNum        NUMBER,
    MaSuatDienNum   NUMBER,
    TrangThai       NVARCHAR2(25),
    CONSTRAINT PK_TTG PRIMARY KEY (MaGheNum, MaSuatDienNum),
    CONSTRAINT FK_TTG_GHE FOREIGN KEY (MaGheNum) REFERENCES GHENGOI(MaGheNum),
    CONSTRAINT FK_TTG_SD FOREIGN KEY (MaSuatDienNum) REFERENCES SUATDIEN(MaSuatDienNum)
);

CREATE TABLE NGHESI(
    MaNgheSiNum  NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    MaNgheSi     CHAR(10) UNIQUE,
    TenNgheSi    NVARCHAR2(255) NOT NULL,
    AnhDaiDien   VARCHAR2(500),
    Email        VARCHAR2(100)
);

CREATE TABLE THAMGIA(
    MaNgheSiNum  NUMBER,
    MaSuKienNum  NUMBER,
    TenBaiHat    NVARCHAR2(255),
    TheLoai      NVARCHAR2(100),
    VaiTro       NVARCHAR2(100),
    CONSTRAINT PK_THAMGIA PRIMARY KEY (MaNgheSiNum, MaSuKienNum),
    CONSTRAINT FK_TG_NS FOREIGN KEY (MaNgheSiNum) REFERENCES NGHESI(MaNgheSiNum),
    CONSTRAINT FK_TG_SK FOREIGN KEY (MaSuKienNum) REFERENCES SUKIEN(MaSuKienNum)
);

CREATE TABLE MAUCHINHSACHHOANTIEN(
    MaChinhSachHTNum NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    MaChinhSachHT    CHAR(10) UNIQUE,
    TenChinhSach     NVARCHAR2(255) NOT NULL,
    MoTa             NVARCHAR2(1000)
);

CREATE TABLE QUY_TAC_HOANTIEN(
    MaQuyTacNum      NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    SoGioTruocSuKien NUMBER(10) NOT NULL,
    TyLeHoanTien     NUMBER(5,2) NOT NULL,
    MaChinhSachHTNum NUMBER,
    CONSTRAINT FK_QT_CSHT FOREIGN KEY (MaChinhSachHTNum) REFERENCES MAUCHINHSACHHOANTIEN(MaChinhSachHTNum)
);

CREATE TABLE DANH_MUC_TIEN_ICH (
    MaTienIchNum    NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    MaTienIch       CHAR(10) UNIQUE,
    TenTienIch      NVARCHAR2(255) NOT NULL,
    LoaiTienIch     NVARCHAR2(100),
    MoTa            NVARCHAR2(1000),
    GiaBan          NUMBER(15, 2) DEFAULT 0,
    AnhSanPham      VARCHAR2(500),
    SLTonKho        NUMBER(10) DEFAULT 0,
    SLMuaGioiHan    NUMBER(5) DEFAULT 1,
    CONSTRAINT CHK_GiaBan_TI CHECK (GiaBan >= 0),
    CONSTRAINT CHK_TonKho_TI CHECK (SLTonKho >= 0)
);

CREATE TABLE HANG_VE (
    MaHangVeNum     NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    MaHangVe        CHAR(10) UNIQUE,
    TenHangVe       NVARCHAR2(100) NOT NULL,
    GiaNiemYet      NUMBER(15, 2) NOT NULL,
    TongSoLuong     NUMBER(10) NOT NULL,
    GioiHanMoiNguoi NUMBER(5),
    MaSuKienNum     NUMBER,
    CONSTRAINT FK_HV_SK FOREIGN KEY (MaSuKienNum) REFERENCES SUKIEN(MaSuKienNum),
    CONSTRAINT CHK_Gia_HV CHECK (GiaNiemYet >= 0),
    CONSTRAINT CHK_SL_HV CHECK (TongSoLuong > 0)
);

CREATE TABLE TIEN_ICH_HANG_VE (
    MaHangVeNum     NUMBER,
    MaTienIchNum    NUMBER,
    SoLuong         NUMBER(5) DEFAULT 0,
    GhiChu          NVARCHAR2(500),
    CONSTRAINT PK_TIHV PRIMARY KEY (MaHangVeNum, MaTienIchNum),
    CONSTRAINT FK_TIHV_HV FOREIGN KEY (MaHangVeNum) REFERENCES HANG_VE(MaHangVeNum),
    CONSTRAINT FK_TIHV_TI FOREIGN KEY (MaTienIchNum) REFERENCES DANH_MUC_TIEN_ICH(MaTienIchNum)
);

CREATE TABLE VE (
    MaVeNum         NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    MaVe            CHAR(10) UNIQUE,
    MaDinhDanh      VARCHAR2(100) UNIQUE,
    LinkQRCode      VARCHAR2(500),
    TrangThaiVe     NVARCHAR2(30) DEFAULT 'Hiệu lực',
    TenNguoiSuDung  NVARCHAR2(255),
    ThoiGianBan     TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    ThoiGianCheckIn TIMESTAMP,

    MaDonMuaNum     NUMBER,
    MaHangVeNum     NUMBER,
    MaGheNum        NUMBER,
    MaSoatVeNum        NUMBER,
    CONSTRAINT FK_VE_HV FOREIGN KEY (MaHangVeNum) REFERENCES HANG_VE(MaHangVeNum),
    CONSTRAINT FK_VE_GHE FOREIGN KEY (MaGheNum) REFERENCES GHENGOI(MaGheNum),
    CONSTRAINT FK_VE_DM FOREIGN KEY (MaDonMuaNum) REFERENCES DONMUA(MaDonMuaNum),
    CONSTRAINT FK_VE_SV FOREIGN KEY (MaSoatVeNum) REFERENCES SOATVE(MaSoatVeNum),
    CONSTRAINT CHK_TrangThai_VE CHECK (TrangThaiVe IN ('Hiệu lực', 'Đã sử dụng/Check-in', 'Đã hủy'))
);

CREATE TABLE NGUOI_DUNG (
    MaNguoiDungNum NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    MaNguoiDung    CHAR(10) UNIQUE,
    HoTen          NVARCHAR2(255) NOT NULL,
    Email          VARCHAR2(100) UNIQUE NOT NULL,
    SoDienThoai    VARCHAR2(20) UNIQUE,
    AnhDaiDien     VARCHAR2(500),
    DaXacThuc      NUMBER(1) DEFAULT 0,
    NgayTao        TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT CK_XT CHECK (DaXacThuc IN (0, 1))
);

CREATE TABLE TAI_KHOAN (
    MaTaiKhoanNum  NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    MaTaiKhoan     CHAR(10) UNIQUE,
    TenDangNhap    VARCHAR2(50) UNIQUE NOT NULL,
    MatKhauMaHoa   VARCHAR2(255) NOT NULL,
    TrangThai      NVARCHAR2(20) DEFAULT 'Hoạt động',
    LanDangNhapCuoi TIMESTAMP,
    DongYNhanMarketing NUMBER(1) DEFAULT 0,
    MaNguoiDungNum NUMBER,
    CONSTRAINT FK_TK_ND FOREIGN KEY (MaNguoiDungNum) REFERENCES NGUOI_DUNG(MaNguoiDungNum),
    CONSTRAINT CHK_TrangThai_TK CHECK (TrangThai IN ('Hoạt động', 'Bị khóa', 'Bị cấm')),
    CONSTRAINT CK_DYNM CHECK (DongYNhanMarketing IN (0, 1))
);

CREATE TABLE CHUC_NANG (
    MaChucNangNum  NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    MaChucNang     CHAR(10) UNIQUE,
    TenChucNang    NVARCHAR2(100) NOT NULL,
    MaChucNangCha  NUMBER,
    DuongDan       VARCHAR2(255),
    CONSTRAINT FK_CN_CN FOREIGN KEY (MaChucNangCha) REFERENCES CHUC_NANG(MaChucNangNum)
);

CREATE TABLE PHAM_VI_QUYEN (
    MaPhamViNum    NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    MaPhamVi       CHAR(10) UNIQUE,
    QuyenThem      NUMBER(1) DEFAULT 0,
    QuyenSua       NUMBER(1) DEFAULT 0,
    QuyenXoa       NUMBER(1) DEFAULT 0,
    QuyenXem       NUMBER(1) DEFAULT 1,
    QuyenXuatFile  NUMBER(1) DEFAULT 0,
    MaChucNangNum  NUMBER NOT NULL,
    CONSTRAINT FK_PVQ_CN FOREIGN KEY (MaChucNangNum) REFERENCES CHUC_NANG(MaChucNangNum)
);

CREATE TABLE NHOM_QUYEN (
    MaNhomQuyenNum NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    MaNhomQuyen    CHAR(10) UNIQUE,
    TenNhomQuyen   NVARCHAR2(100) NOT NULL,
    MoTa           NVARCHAR2(500),
    IsSystem       NUMBER(1) DEFAULT 0
);

CREATE TABLE CAU_HINH_NHOM_QUYEN (
    MaNhomQuyenNum NUMBER,
    MaPhamViNum    NUMBER,
    PRIMARY KEY (MaNhomQuyenNum, MaPhamViNum),
    FOREIGN KEY (MaNhomQuyenNum) REFERENCES NHOM_QUYEN(MaNhomQuyenNum),
    FOREIGN KEY (MaPhamViNum) REFERENCES PHAM_VI_QUYEN(MaPhamViNum)
);

CREATE TABLE DONMUA(
    MaDonMuaNum         NUMBER GENERATED BY DEFAULT AS IDENTITY  PRIMARY KEY,
    MaDonMua            CHAR(10) UNIQUE,
    NgayDat             DATE DEFAULT CURRENT_DATE,
    TongTien            NUMBER(50,5),
    TrangThaiThanhToan  NVARCHAR2(50) DEFAULT 'Chờ thanh toán',
    PhuongThucThanhToan NVARCHAR2(50),
    MaGiamGiaNum        NUMBER,
    MaNguoiDungNum      NUMBER,
    CONSTRAINT CK_TTTT CHECK(TrangThaiThanhToan IN ('Chờ thanh toán', 'Đã thanh toán', 'Đã hủy', 'Đã hoàn tiền')),
    CONSTRAINT FK_DM_GG FOREIGN KEY (MaGiamGiaNum) REFERENCES GIAMGIA(MaGiamGiaNum),
    CONSTRAINT FK_DM_ND FOREIGN KEY (MaNguoiDungNum) REFERENCES NGUOIDUNG(MaNguoiDungNum)

)