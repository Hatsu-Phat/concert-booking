ALTER SESSION SET CURRENT_SCHEMA = CONCERT_BOOKING;

CREATE TABLE DIADIEM(
    MaDiaDiemNum    NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    MaDiaDiem       VARCHAR2(10) UNIQUE,
    TenDiaDiem      NVARCHAR2(255) NOT NULL,
    SucChua         NUMBER(38) NOT NULL,
    DiaChi          NVARCHAR2(255) NOT NULL
);

CREATE TABLE SUKIEN(
    MaSuKienNum         NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    MaSuKien            VARCHAR2(10) UNIQUE,
    TenSuKien           NVARCHAR2(255) NOT NULL,
    ThoiGian            DATE NOT NULL,
    MoTa                NVARCHAR2(1000),
    TrangThai           NVARCHAR2(25) DEFAULT 'Sắp diễn ra',
    TyLeHoaHong         NUMBER(5,2),
    QuyDinhSuKien       NVARCHAR2(1000),
    MaDiaDiemNum        NUMBER,
    MaChinhSachHTNum    NUMBER,
    CONSTRAINT CK_TrangThai CHECK (TrangThai IN ('Sắp diễn ra', 'Đang diễn ra', 'Đã kết thúc', 'Đã hủy')),
    CONSTRAINT FK_SK_DD FOREIGN KEY (MaDiaDiemNum) REFERENCES DIADIEM(MaDiaDiemNum),
    CONSTRAINT FK_SK_MCSHT FOREIGN KEY (MaChinhSachHTNum) REFERENCES MAUCHINHSACHHOANTIEN(MaChinhSachHTNum),
    CONSTRAINT CK_TLHH CHECK(TyLeHoaHong BETWEEN 0 AND 100)
);

CREATE TABLE SUATDIEN(
    MaSuatDienNum   NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    MaSuatDien      VARCHAR2(10) UNIQUE,
    TenSuatDien     NVARCHAR2(255) NOT NULL,
    ThoiGianBatDau  DATE NOT NULL,
    ThoiGianKetThuc DATE,
    TrangThaiBanVe  NVARCHAR2(50),
    MaSuKienNum     NUMBER,
    CONSTRAINT FK_SD_SK FOREIGN KEY (MaSuKienNum) REFERENCES SUKIEN(MaSuKienNum)
);

CREATE TABLE NHATAITRO (
    MaNhaTTNum   NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    MaNhaTT      VARCHAR2(10) UNIQUE,
    TenNhaTT     NVARCHAR2(255) NOT NULL
);

CREATE TABLE TAITRO (
    MaSuKienNum  NUMBER,
    MaNhaTTNum   NUMBER,
    HangTaiTro   NVARCHAR2(20) DEFAULT 'Chưa có hạng tài trợ',
    CONSTRAINT PK_TAITRO PRIMARY KEY (MaSuKienNum, MaNhaTTNum),
    CONSTRAINT FK_TAITRO_SK FOREIGN KEY (MaSuKienNum) REFERENCES SUKIEN(MaSuKienNum),
    CONSTRAINT FK_TAITRO_NTT FOREIGN KEY (MaNhaTTNum) REFERENCES NHATAITRO(MaNhaTTNum),
    CONSTRAINT CHK_HangTaiTro CHECK (HangTaiTro IN ('Đồng', 'Bạc', 'Vàng', 'Kim Cương'))
);

CREATE TABLE KHUVUC(
    MaKhuVucNum  NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    MaKhuVuc     VARCHAR2(10) UNIQUE,
    TenKhuVuc    NVARCHAR2(100) NOT NULL,
    SucChuaKV    NUMBER(10) NOT NULL,
    MaSuKienNum  NUMBER,
    CONSTRAINT FK_KV_SK FOREIGN KEY (MaSuKienNum) REFERENCES SUKIEN(MaSuKienNum)
);

CREATE TABLE GHENGOI(
    MaGheNum     NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    MaGhe        VARCHAR2(10) UNIQUE,
    SoHang       NUMBER(5),
    SoGhe        NUMBER(5),
    ToaDo        VARCHAR2(50),
    MaKhuVucNum  NUMBER,
    CONSTRAINT FK_GHE_KV FOREIGN KEY (MaKhuVucNum) REFERENCES KHUVUC(MaKhuVucNum)
);

CREATE TABLE TRANGTHAIGHETHEOSUAT(
    MaGheNum        NUMBER,
    MaSuatDienNum   NUMBER,
    TrangThai       NVARCHAR2(25),
    CONSTRAINT PK_TTG PRIMARY KEY (MaGheNum, MaSuatDienNum),
    CONSTRAINT FK_TTG_GHE FOREIGN KEY (MaGheNum) REFERENCES GHENGOI(MaGheNum),
    CONSTRAINT FK_TTG_SD FOREIGN KEY (MaSuatDienNum) REFERENCES SUATDIEN(MaSuatDienNum)
);

CREATE TABLE NGHESI(
    MaNgheSiNum  NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    MaNgheSi     VARCHAR2(10) UNIQUE,
    TenNgheSi    NVARCHAR2(255) NOT NULL,
    AnhDaiDien   VARCHAR2(500),
    Email        VARCHAR2(100)
);

CREATE TABLE THAMGIA(
    MaNgheSiNum  NUMBER,
    MaSuKienNum  NUMBER,
    TenBaiHat    NVARCHAR2(255),
    TheLoai      NVARCHAR2(100),
    VaiTro       NVARCHAR2(100),
    CONSTRAINT PK_THAMGIA PRIMARY KEY (MaNgheSiNum, MaSuKienNum),
    CONSTRAINT FK_TG_NS FOREIGN KEY (MaNgheSiNum) REFERENCES NGHESI(MaNgheSiNum),
    CONSTRAINT FK_TG_SK FOREIGN KEY (MaSuKienNum) REFERENCES SUKIEN(MaSuKienNum)
);

CREATE TABLE MAUCHINHSACHHOANTIEN(
    MaChinhSachHTNum NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    MaChinhSachHT    VARCHAR2(10) UNIQUE,
    TenChinhSach     NVARCHAR2(255) NOT NULL,
    MoTa             NVARCHAR2(1000)
);

CREATE TABLE QUYTACHOANTIEN(
    MaQuyTacNum      NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    SoGioTruocSuKien NUMBER(10) NOT NULL,
    TyLeHoanTien     NUMBER(5,2) NOT NULL,
    MaChinhSachHTNum NUMBER,
    CONSTRAINT FK_QT_CSHT FOREIGN KEY (MaChinhSachHTNum) REFERENCES MAUCHINHSACHHOANTIEN(MaChinhSachHTNum),
    CONSTRAINT CK_TLHT CHECK(TyLeHoanTien BETWEEN 0 AND 100)
);

CREATE TABLE DANHMUCTIENICH (
    MaTienIchNum    NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    MaTienIch       VARCHAR2(10) UNIQUE,
    TenTienIch      NVARCHAR2(255) NOT NULL,
    LoaiTienIch     NVARCHAR2(100),
    MoTa            NVARCHAR2(1000),
    GiaBan          NUMBER(15, 2) DEFAULT 0,
    AnhSanPham      VARCHAR2(500),
    SLTonKho        NUMBER(10) DEFAULT 0,
    SLMuaGioiHan    NUMBER(5) DEFAULT 1,
    CONSTRAINT CHK_GiaBan_TI CHECK (GiaBan >= 0),
    CONSTRAINT CHK_TonKho_TI CHECK (SLTonKho >= 0)
);

CREATE TABLE HANGVE (
    MaHangVeNum     NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    MaHangVe        VARCHAR2(10) UNIQUE,
    TenHangVe       NVARCHAR2(100) NOT NULL,
    GiaNiemYet      NUMBER(15, 2) NOT NULL,
    TongSoLuong     NUMBER(10) NOT NULL,
    GioiHanMoiNguoi NUMBER(5),
    MaSuKienNum     NUMBER,
    CONSTRAINT FK_HV_SK FOREIGN KEY (MaSuKienNum) REFERENCES SUKIEN(MaSuKienNum),
    CONSTRAINT CHK_Gia_HV CHECK (GiaNiemYet >= 0),
    CONSTRAINT CHK_SL_HV CHECK (TongSoLuong > 0)
);

CREATE TABLE TIENICHHANGVE (
    MaHangVeNum     NUMBER,
    MaTienIchNum    NUMBER,
    SoLuong         NUMBER(5) DEFAULT 0,
    GhiChu          NVARCHAR2(500),
    CONSTRAINT PK_TIHV PRIMARY KEY (MaHangVeNum, MaTienIchNum),
    CONSTRAINT FK_TIHV_HV FOREIGN KEY (MaHangVeNum) REFERENCES HANGVE(MaHangVeNum),
    CONSTRAINT FK_TIHV_TI FOREIGN KEY (MaTienIchNum) REFERENCES DANHMUCTIENICH(MaTienIchNum)
);

CREATE TABLE VE (
    MaVeNum         NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    MaVe            VARCHAR2(10) UNIQUE,
    MaDinhDanh      VARCHAR2(100) UNIQUE,
    LinkQRCode      VARCHAR2(500),
    TrangThaiVe     NVARCHAR2(30) DEFAULT 'Hiệu lực',
    TenNguoiSuDung  NVARCHAR2(255),
    ThoiGianBan     TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    ThoiGianCheckIn TIMESTAMP,
    MaDonMuaNum     NUMBER,
    MaHangVeNum     NUMBER,
    MaGheNum        NUMBER,
    MaSoatVeNum        NUMBER,
    CONSTRAINT FK_VE_HV FOREIGN KEY (MaHangVeNum) REFERENCES HANGVE(MaHangVeNum),
    CONSTRAINT FK_VE_GHE FOREIGN KEY (MaGheNum) REFERENCES GHENGOI(MaGheNum),
    CONSTRAINT FK_VE_DM FOREIGN KEY (MaDonMuaNum) REFERENCES DONMUA(MaDonMuaNum),
    CONSTRAINT FK_VE_SV FOREIGN KEY (MaSoatVeNum) REFERENCES SOATVE(MaSoatVeNum),
    CONSTRAINT CHK_TrangThai_VE CHECK (TrangThaiVe IN ('Hiệu lực', 'Đã sử dụng/Check-in', 'Đã hủy'))
);

CREATE TABLE NGUOIDUNG (
    MaNguoiDungNum NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    MaNguoiDung    VARCHAR2(10) UNIQUE,
    HoTen          NVARCHAR2(255) NOT NULL,
    Email          VARCHAR2(100) UNIQUE NOT NULL,
    SoDienThoai    VARCHAR2(20) UNIQUE,
    AnhDaiDien     VARCHAR2(500),
    DaXacThuc      NUMBER(1) DEFAULT 0,
    NgayTao        TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT CK_XT CHECK (DaXacThuc IN (0, 1))
);

CREATE TABLE TAIKHOAN (
    MaTaiKhoanNum  NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    MaTaiKhoan     VARCHAR2(10) UNIQUE,
    TenDangNhap    VARCHAR2(50) UNIQUE NOT NULL,
    MatKhauMaHoa   VARCHAR2(255) NOT NULL,
    TrangThai      NVARCHAR2(20) DEFAULT 'Hoạt động',
    LanDangNhapCuoi TIMESTAMP,
    DongYNhanMarketing NUMBER(1) DEFAULT 0,
    MaNguoiDungNum NUMBER,
    CONSTRAINT FK_TK_ND FOREIGN KEY (MaNguoiDungNum) REFERENCES NGUOIDUNG(MaNguoiDungNum),
    CONSTRAINT CHK_TrangThai_TK CHECK (TrangThai IN ('Hoạt động', 'Bị khóa', 'Bị cấm')),
    CONSTRAINT CK_DYNM CHECK (DongYNhanMarketing IN (0, 1))
);

CREATE TABLE CHUCNANG (
    MaChucNangNum  NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    MaChucNang     VARCHAR2(10) UNIQUE,
    TenChucNang    NVARCHAR2(100) NOT NULL,
    MaChucNangCha  NUMBER,
    DuongDan       VARCHAR2(255),
    CONSTRAINT FK_CN_CN FOREIGN KEY (MaChucNangCha) REFERENCES CHUCNANG(MaChucNangNum)
);

CREATE TABLE PHAMVIQUYEN (
    MaPhamViNum    NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    MaPhamVi       VARCHAR2(10) UNIQUE,
    QuyenThem      NUMBER(1) DEFAULT 0,
    QuyenSua       NUMBER(1) DEFAULT 0,
    QuyenXoa       NUMBER(1) DEFAULT 0,
    QuyenXem       NUMBER(1) DEFAULT 1,
    QuyenXuatFile  NUMBER(1) DEFAULT 0,
    MaChucNangNum  NUMBER NOT NULL,
    CONSTRAINT FK_PVQ_CN FOREIGN KEY (MaChucNangNum) REFERENCES CHUCNANG(MaChucNangNum)
);

CREATE TABLE NHOMQUYEN (
    MaNhomQuyenNum NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    MaNhomQuyen    VARCHAR2(10) UNIQUE,
    TenNhomQuyen   NVARCHAR2(100) NOT NULL,
    MoTa           NVARCHAR2(500),
    IsSystem       NUMBER(1) DEFAULT 0
);

CREATE TABLE CAUHINHNHOMQUYEN (
    MaNhomQuyenNum NUMBER,
    MaPhamViNum    NUMBER,
    PRIMARY KEY (MaNhomQuyenNum, MaPhamViNum),
    FOREIGN KEY (MaNhomQuyenNum) REFERENCES NHOMQUYEN(MaNhomQuyenNum),
    FOREIGN KEY (MaPhamViNum) REFERENCES PHAMVIQUYEN(MaPhamViNum)
);

CREATE TABLE PHANQUYENNHOM(
    MaTaiKhoanNum  NUMBER,
    MaNhomQuyenNum NUMBER,
    PRIMARY KEY (MaTaiKhoanNum, MaNhomQuyenNum),
    FOREIGN KEY (MaTaiKhoanNum) REFERENCES TAIKHOAN(MaTaiKhoanNum),
    FOREIGN KEY (MaNhomQuyenNum) REFERENCES NHOMQUYEN(MaNhomQuyenNum)
);

CREATE TABLE PHANQUYENTAIKHOAN(
    MaTaiKhoanNum   NUMBER,
    MaPhamViNum     NUMBER,
    PRIMARY KEY (MaTaiKhoanNum, MaPhamViNum),
    FOREIGN KEY (MaPhamViNum) REFERENCES  PHAMVIQUYEN(MaPhamViNum),
    FOREIGN KEY (MaTaiKhoanNum) REFERENCES  TAIKHOAN(MaTaiKhoanNum)
);

CREATE TABLE PHANCONGSUKIENNHANVIEN (
    MaNguoiDungNum   NUMBER,
    MaSuKienNum      NUMBER,
    PRIMARY KEY (MaNguoiDungNum, MaSuKienNum),
    FOREIGN KEY (MaNguoiDungNum) REFERENCES NGUOIDUNG(MaNguoiDungNum),
    FOREIGN KEY (MaSuKienNum) REFERENCES SUKIEN(MaSuKienNum)
);

CREATE TABLE HANGCHO (
    MaHangChoNum     NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    MaHangCho        VARCHAR2(10) UNIQUE,
    ThoiGianVao      TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    TrangThai        NVARCHAR2(50) DEFAULT 'Đang chờ',
    MaSuKienNum      NUMBER,
    MaTaiKhoanNum    NUMBER,
    CONSTRAINT FK_HC_SK FOREIGN KEY (MaSuKienNum) REFERENCES SUKIEN(MaSuKienNum),
    CONSTRAINT FK_HC_TK FOREIGN KEY (MaTaiKhoanNum) REFERENCES TAIKHOAN(MaTaiKhoanNum),
    CONSTRAINT CHK_TrangThai_HC CHECK (TrangThai IN ('Đang chờ', 'Được Vào', 'Hết lượt/Bỏ cuộc'))
);

CREATE TABLE NHATOCHUC (
    MaNhaToChucNum   NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    MaNhaToChuc      VARCHAR2(10) UNIQUE,
    TenNhaToChuc     NVARCHAR2(255) NOT NULL,
    MaSoThue         VARCHAR2(20) UNIQUE,
    MaNguoiDaiDienNum NUMBER NOT NULL,
    ThongTinNganHang NVARCHAR2(500),
    EmailHoTro       VARCHAR2(100),
    TrangThai        NVARCHAR2(50) DEFAULT 'Hoạt động',
    CONSTRAINT FK_NTC_ND FOREIGN KEY (MaNguoiDaiDienNum) REFERENCES NGUOIDUNG(MaNguoiDungNum)
);

CREATE TABLE LICHSUQUYETTOAN (
    MaQTNum          NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    MaQT             CHAR(15) UNIQUE,
    MaNhaToChucNum   NUMBER NOT NULL,
    KyQT             NVARCHAR2(100) NOT NULL,
    NgayQuyetToan    DATE DEFAULT SYSDATE,
    TongDoanhThu     NUMBER(15, 2) NOT NULL,
    PhiNenTang       NUMBER(15, 2) NOT NULL,
    SoTienChuyen     NUMBER(15, 2) NOT NULL,
    ChungTuThanhToan VARCHAR2(500),
    TrangThai        NVARCHAR2(50) DEFAULT 'Đang xử lý',
    CONSTRAINT FK_LSQT_NTC FOREIGN KEY (MaNhaToChucNum) REFERENCES NHATOCHUC(MaNhaToChucNum)
);

CREATE TABLE DONMUA(
    MaDonMuaNum         NUMBER GENERATED BY DEFAULT AS IDENTITY  PRIMARY KEY,
    MaDonMua            VARCHAR2(10) UNIQUE,
    NgayDat             DATE DEFAULT CURRENT_DATE,
    TongTien            NUMBER(50,5),
    TrangThaiThanhToan  NVARCHAR2(50) DEFAULT 'Chờ thanh toán',
    PhuongThucThanhToan NVARCHAR2(50),
    MaGiamGiaNum        NUMBER,
    MaNguoiDungNum      NUMBER,
    CONSTRAINT CK_TTTT CHECK(TrangThaiThanhToan IN ('Chờ thanh toán', 'Đã thanh toán', 'Đã hủy', 'Đã hoàn tiền')),
    CONSTRAINT FK_DM_GG FOREIGN KEY (MaGiamGiaNum) REFERENCES GIAMGIA(MaGiamGiaNum),
    CONSTRAINT FK_DM_ND FOREIGN KEY (MaNguoiDungNum) REFERENCES NGUOIDUNG(MaNguoiDungNum)
);

CREATE TABLE CHINHSACHHETHONG (
    MaChinhSachNum   NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    MaChinhSach      VARCHAR2(10) UNIQUE,
    LoaiChinhSach    NVARCHAR2(100) NOT NULL,
    TieuDe           NVARCHAR2(255) NOT NULL,
    NoiDung          CLOB NOT NULL,
    PhienBan         VARCHAR2(10) NOT NULL,
    NgayHieuLuc      DATE DEFAULT SYSDATE,
    DoiTuongApDung   VARCHAR2(50),
    TrangThai        VARCHAR2(20) DEFAULT 'Nháp',
    CONSTRAINT CHK_TrangThai_CS CHECK (TrangThai IN ('Đang áp dụng', 'Nháp', 'Lưu trữ'))
);

CREATE TABLE LICHSUDONGYCHINHSACH (
    MaNguoiDungNum   NUMBER,
    MaChinhSachNum   NUMBER,
    ThoiGianDongY    TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (MaNguoiDungNum, MaChinhSachNum),
    FOREIGN KEY (MaNguoiDungNum) REFERENCES NGUOIDUNG(MaNguoiDungNum),
    FOREIGN KEY (MaChinhSachNum) REFERENCES CHINHSACHHETHONG(MaChinhSachNum)
);

CREATE TABLE CHIENDICHKHUYENMAI (
    MaChienDichNum   NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    MaChienDich      VARCHAR2(10) UNIQUE,
    TenChienDich     NVARCHAR2(255) NOT NULL,
    ThoiDiemBD       TIMESTAMP NOT NULL,
    ThoiDiemKT       TIMESTAMP NOT NULL,
    TrangThai        NVARCHAR2(50),
    CONSTRAINT CHK_ThoiGian_CD CHECK (ThoiDiemKT > ThoiDiemBD)
);

CREATE TABLE MAGIAMGIA (
    MaGiamGia        VARCHAR2(50) PRIMARY KEY,
    MaChienDichNum   NUMBER,
    LoaiGiam         VARCHAR2(20),
    SoLuongGiam      NUMBER(15, 2) NOT NULL,
    GiamToiDa        NUMBER(15, 2),
    LuotDungToiDa    NUMBER(10) DEFAULT 1,
    DaSuDung         NUMBER(10) DEFAULT 0,
    CONSTRAINT FK_MGG_CD FOREIGN KEY (MaChienDichNum) REFERENCES CHIENDICHKHUYENMAI(MaChienDichNum),
    CONSTRAINT CHK_LuotDung CHECK (DaSuDung <= LuotDungToiDa),
    CONSTRAINT CHK_LG_MGG CHECK (LoaiGiam IN ('Theo phần trăm', 'Số tiền cố định'))

);

CREATE TABLE APDUNG (
    MaDonMuaNum      NUMBER,
    MaGiamGia        VARCHAR2(50),
    ThoiDiemApDung   TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    SoTienGiamThucTe NUMBER(15, 2) NOT NULL,
    PRIMARY KEY (MaDonMuaNum, MaGiamGia),
    FOREIGN KEY (MaDonMuaNum) REFERENCES DONMUA(MaDonMuaNum),
    FOREIGN KEY (MaGiamGia) REFERENCES MAGIAMGIA(MaGiamGia)
);

CREATE TABLE YEUCAUHOTRO (
    MaYeuCauNum      NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    MaYeuCau         VARCHAR2(10) UNIQUE,
    LoaiYeuCau       NVARCHAR2(100),
    NoiDung          NVARCHAR2(2000),
    ThoiDiemYeuCau   TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    TrangThaiXuLy    NVARCHAR2(50) DEFAULT 'Mới',
    MaDonMuaNum      NUMBER,
    MaNguoiDungNum   NUMBER,
    MaNhanVienXuLyNum NUMBER,
    CONSTRAINT FK_YCHT_DM FOREIGN KEY (MaDonMuaNum) REFERENCES DONMUA(MaDonMuaNum),
    CONSTRAINT FK_YCHT_ND FOREIGN KEY (MaNguoiDungNum) REFERENCES NGUOIDUNG(MaNguoiDungNum),
    CONSTRAINT FK_YCHT_NV FOREIGN KEY (MaNhanVienXuLyNum) REFERENCES TAIKHOAN(MaTaiKhoanNum),
    CONSTRAINT CHK_TrangThai_YCHT CHECK (TrangThaiXuLy IN ('Mới', 'Đang xử lý', 'Chờ phản hồi', 'Đã đóng'))
);

CREATE TABLE GIAODICH (
    MaGiaoDichNum      NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    MaGiaoDich         VARCHAR2(30) UNIQUE,
    MaGiaoDichCongTT   VARCHAR2(100),
    PhuongThuc         VARCHAR2(50) NOT NULL,
    SoTien             NUMBER(15, 2) NOT NULL,
    TrangThai          VARCHAR2(20) DEFAULT 'PENDING',
    MaLoi              VARCHAR2(50),
    DuLieuPhanHoi      CLOB,
    ThoiGianTao        TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    MaDonMuaNum        NUMBER,
    CONSTRAINT FK_GD_DM_NUM FOREIGN KEY (MaDonMuaNum) REFERENCES DONMUA(MaDonMuaNum),
    CONSTRAINT CHK_TrangThai_GD CHECK (TrangThai IN ('PENDING', 'SUCCESS', 'FAILED')),
    CONSTRAINT CHK_JSON_GD CHECK (DuLieuPhanHoi IS JSON)
);

CREATE TABLE GIAODICHBANLAI (
    MaGiaoDichNum    NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    MaGiaoDich       VARCHAR2(20) UNIQUE,
    GiaNiemYet       NUMBER(15, 2) NOT NULL,
    GiaChot          NUMBER(15, 2),
    PhiSan           NUMBER(15, 2),
    TrangThai        NVARCHAR2(20) DEFAULT 'Đang bán',
    LogLichSu        CLOB,
    NgayTao          TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    NgayHoanTat      TIMESTAMP,
    MaVeNum          NUMBER,
    NguoiBanID       NUMBER,
    NguoiMuaID       NUMBER,
    CONSTRAINT FK_GDBL_VE FOREIGN KEY (MaVeNum) REFERENCES VE(MaVeNum),
    CONSTRAINT FK_GDBL_BAN FOREIGN KEY (NguoiBanID) REFERENCES TAIKHOAN(MaTaiKhoanNum),
    CONSTRAINT FK_GDBL_MUA FOREIGN KEY (NguoiMuaID) REFERENCES TAIKHOAN(MaTaiKhoanNum),
    CONSTRAINT CHK_JSON_GDBL CHECK (LogLichSu IS JSON),
    CONSTRAINT CHK_TrangThai_GDBL CHECK (TrangThai IN ('Đang bán', 'Đã bán', 'Đã hủy'))
);

CREATE TABLE NHATKYSOATVE (
    MaNhatKySVNum    NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    MaNhatKySV       VARCHAR2(20) UNIQUE,
    TrangThaiSoatVe  NUMBER(1) DEFAULT 0,
    ThoiGianQuetMa   TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    ThietBiQuet      NVARCHAR2(100),
    MaVeNum          NUMBER,
    MaTaiKhoanNum    NUMBER,
    CONSTRAINT FK_NKSV_VE FOREIGN KEY (MaVeNum) REFERENCES VE(MaVeNum),
    CONSTRAINT FK_NKSV_TK FOREIGN KEY (MaTaiKhoanNum) REFERENCES TAIKHOAN(MaTaiKhoanNum),
    CONSTRAINT CHK_TrangThai_SV CHECK (TrangThaiSoatVe IN (0, 1))
);

CREATE TABLE NHATKYHETHONG (
    MaNhatKyHTNum  NUMBER(19) GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    MaNhatKyHT     VARCHAR2(20) UNIQUE,
    HanhDong       VARCHAR2(50) NOT NULL,
    TenBang        VARCHAR2(50) NOT NULL,
    MaDoiTuong     NUMBER NOT NULL,
    DuLieuCu       CLOB,
    DuLieuMoi      CLOB,
    LyDo           NVARCHAR2(500),
    ThoiDiemThucHien TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    MaTaiKhoanNum  NUMBER,
    CONSTRAINT FK_NKHT_TK FOREIGN KEY (MaTaiKhoanNum) REFERENCES TAIKHOAN(MaTaiKhoanNum),
    CONSTRAINT CHK_JSON_Cu CHECK (DuLieuCu IS JSON),
    CONSTRAINT CHK_JSON_Moi CHECK (DuLieuMoi IS JSON)
);

CREATE TABLE NHATKYTHONGBAO (
    MaThongBaoNum  NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    MaThongBao     VARCHAR2(20) UNIQUE,
    KenhGui        VARCHAR2(20),
    NoiDung        CLOB,
    TrangThai      NVARCHAR2(20) DEFAULT 'Đã gửi',
    ThoiDiemGui    TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    ThoiDiemNhan   TIMESTAMP,
    MaNguoiDungNum NUMBER,
    MaDonMuaNum    NUMBER,
    CONSTRAINT FK_NKTB_ND FOREIGN KEY (MaNguoiDungNum) REFERENCES NGUOIDUNG(MaNguoiDungNum),
    CONSTRAINT FK_NKTB_DM FOREIGN KEY (MaDonMuaNum) REFERENCES DONMUA(MaDonMuaNum),
    CONSTRAINT CHK_Kenh CHECK (KenhGui IN ('EMAIL', 'SMS', 'PUSH_APP', 'ZALO')),
    CONSTRAINT CHK_TT CHECK (TrangThai IN ('Đã gửi', 'Thất bại', 'Đã nhận', 'Đã xem'))
);

CREATE TABLE NHATKYDANGNHAP (
    MaLogNum       NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    MaLog          VARCHAR2(20) UNIQUE,
    TenDangNhapNhapVao VARCHAR2(50),
    ThoiGian       TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    TrangThai      VARCHAR2(10),
    LyDoThatBai    NVARCHAR2(100),
    DiaChiIP       VARCHAR2(45),
    UserAgent      VARCHAR2(500),
    MaTaiKhoanNum  NUMBER,
    CONSTRAINT FK_NKDN_TK FOREIGN KEY (MaTaiKhoanNum) REFERENCES TAIKHOAN(MaTaiKhoanNum),
    CONSTRAINT CHK_TT_DN CHECK (TrangThai IN ('SUCCESS', 'FAIL'))
);